name: Build and Release CoolmasterConfigurator

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.x"

      - name: Derive version info from tag
        id: ver
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"   # e.g. v1.4.0 or v1.4.1 or v1.4.0-b1
          if (-not $tag.StartsWith("v")) {
            throw "Tag must start with 'v' (e.g., v1.4.0). Got: $tag"
          }

          $version = $tag.Substring(1)      # e.g. 1.4.0 or 1.4.1 or 1.4.0-b1

          # We only care about MAJOR.MINOR.PATCH for versioning/prerelease logic.
          # Suffix is ignored for classification; we strip it only to parse the numeric version.
          $base = $version.Split("-")[0]    # 1.4.0 from 1.4.0-b1
          if ($base -notmatch "^\d+\.\d+\.\d+$") {
            throw "Base version must be MAJOR.MINOR.PATCH (e.g., 1.4.0). Got: $base (from tag $tag)"
          }

          $parts = $base.Split(".")
          $patch = [int]$parts[2]

          # Rule: x.x.0 => release, everything else => prerelease
          $isPrerelease = ($patch -ne 0)

          # AssemblyVersion/FileVersion must be numeric (4-part)
          $assembly = "$base.0"             # 1.4.0.0

          $pr = $isPrerelease.ToString().ToLowerInvariant()
          $mkLatest = (!$isPrerelease).ToString().ToLowerInvariant()

          "tag=$tag"               | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "version=$version"       | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "base=$base"             | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "assembly=$assembly"     | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "prerelease=$pr"         | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "make_latest=$mkLatest"  | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Restore
        shell: pwsh
        run: dotnet restore "CoolmasterConfigurator/CoolmasterConfigurator.csproj"

      - name: Build
        shell: pwsh
        run: |
          dotnet build "CoolmasterConfigurator/CoolmasterConfigurator.csproj" -c Release --no-restore `
            /p:Version="${{ steps.ver.outputs.version }}" `
            /p:AssemblyVersion="${{ steps.ver.outputs.assembly }}" `
            /p:FileVersion="${{ steps.ver.outputs.assembly }}" `
            /p:InformationalVersion="${{ steps.ver.outputs.version }}" `
            /p:ContinuousIntegrationBuild=true

      - name: Publish (Portable)
        shell: pwsh
        run: |
          dotnet publish "CoolmasterConfigurator/CoolmasterConfigurator.csproj" -c Release -o ./publish/portable --no-build `
            /p:Version="${{ steps.ver.outputs.version }}" `
            /p:AssemblyVersion="${{ steps.ver.outputs.assembly }}" `
            /p:FileVersion="${{ steps.ver.outputs.assembly }}" `
            /p:InformationalVersion="${{ steps.ver.outputs.version }}" `
            /p:ContinuousIntegrationBuild=true

      - name: Create zip archive (Portable)
        id: zip
        shell: pwsh
        run: |
          $tag = "${{ steps.ver.outputs.tag }}"
          $zipName = "CoolmasterConfigurator_Portable_$tag.zip"
          Compress-Archive -Path ./publish/portable/* -DestinationPath ./$zipName -Force
          "zip=$zipName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create GitHub Release + upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          prerelease: ${{ steps.ver.outputs.prerelease }}
          make_latest: ${{ steps.ver.outputs.make_latest }}
          files: ${{ steps.zip.outputs.zip }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
